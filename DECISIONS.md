# DECISIONS.md — 설계 결정 이력

plans/ 문서의 설계 결정이 추가되거나 변경될 때 기록한다.
코드 변경 이력은 git commit을 참고한다.

---

## 2025-02-26

### [13] DesktopOverlay — WindowKind 체계 분리
- **결정**: DesktopOverlay는 WindowKind 체계 바깥의 별도 시스템 레이어로 분리한다.
- **이유**: WindowKind는 두 모드(NATIVE_OS/VIRTUAL_DESKTOP) 모두 지원 의무가 있으나,
  DesktopOverlay는 NATIVE_OS 전용이라 체계 내 포함 시 §2.2-1 충돌 발생.

### [13] DesktopOverlay — Z-order 전략
- **결정**: 생성 시 Win32 `SetWindowPos(HWND_BOTTOM)` 1회 호출로 바닥 고정.
  이후 다른 게임 창은 별도 처리 없이 자동으로 위에 위치.
- **이유**: 토글 시마다 모든 창을 순회하는 방식은 창이 많아질수록 비용 증가.
  `FLAG_NO_FOCUS` 조합으로 Z-order가 자동으로 올라가는 현상도 방지됨.

### [13] DesktopOverlay — 모니터 식별
- **결정**: 모니터 핑거프린트(해상도 + DPI 배율 조합)를 내부 식별 키로 사용.
  UI 표시명은 `background_0`, `background_1` 등 인덱스 기반.
- **이유**: 모니터 연결 순서(인덱스)는 변경될 수 있어 식별자로 부적합.

### [13] 메인 창 구조 — 터미널을 서브 윈도우로 분리 (ideation)
- **결정**: 확정 아님. 장기적으로 메인 창을 투명 호스트로 두고,
  터미널/GUI 메인화면을 모두 서브 윈도우로 다루는 구조를 검토 중.
- **이유**: 게임 중반 이후 GUI 메인화면 추가 시 "메인 창 = 터미널" 가정이
  구조적으로 깨지는 문제를 사전에 방지.
- **현재 상태**: ideation 단계. 확정 시 13 문서 대규모 수정 필요.

### [03] import 라이브러리 계약 — @name 강제
- **결정**: 파일 최상단 연속 주석 블록에 `@name`이 있는 파일만 import 가능.
  `@name` 없는 파일 import 시도 시 `ERR_NOT_A_LIBRARY` 반환.
- **이유**: 실행용 스크립트와 라이브러리 스크립트를 구조적으로 구분.
  규칙이 단순해서 "import하고 싶으면 @name 달아라" 한 줄로 설명 가능.

### [14] scripts 프로그램 — config 서브커맨드
- **결정**: `scripts move` 대신 `scripts config`로 `.scripts_registry`를
  edit systemcall로 열어준다.
- **이유**: 순서 조정뿐 아니라 추가/삭제도 파일 직접 편집으로 가능해서
  전용 커맨드 여러 개 만드는 것보다 단순하고 강력함.
  `git config --edit`과 동일한 패턴으로 직관적.

### [14] scripts 프로그램 — 디렉토리 등록 flat 정책
- **결정**: `scripts add <dir>` 시 해당 디렉토리만 탐색(비재귀, flat).
- **이유**: LD_LIBRARY_PATH와 동일한 관례. 재귀 허용 시 탐색 범위 예측 불가.

### [04] 힌트 시스템 — LLM 미사용
- **결정**: hint agent는 LLM이 아닌 룰 테이블 기반으로 구현한다.
- **이유**: Qwen2.5-0.5B는 §3.3 간접 프롬프트 인젝션 미션의 공격 대상 NPC 전용.
  힌트용으로 쓰면 "공격 대상 LLM"과 "도움 주는 LLM" 역할이 혼재되어
  플레이어가 힌트 에이전트를 공격하려 드는 등 혼란 발생 가능.

### [15] 게임 시작 연출 — 타이핑 애니메이션
- **결정**: 최초 부팅 시 터미널에 `cat /home/<userId>/README` 명령어가
  한 글자씩 타이핑되는 애니메이션을 보여주고, 플레이어는 엔터만 치면 된다.
  최초 1회만 표시.
- **이유**: MOTD "help 쳐보세요"는 수동적이라 유저가 읽지 않을 수 있음.
  타이핑 애니메이션이 "지금 입력 중" 신호를 시각적으로 전달해
  엔터에 손이 가도록 자연스럽게 유도.

### [15] NEXUS 워크스테이션 이름 고정
- **결정**: 워크스테이션 이름은 `nexus`로 고정. 변경 불가.
- **이유**: 이전 주인의 흔적으로 스토리 훅과 연계됨(§4.1).
  이름 변경 기능을 구현하지 않아도 되는 실용적 이점도 있음.

### [15] MOTD "마지막 로그인" — 스토리 훅 연계
- **결정**: 최초 부팅 MOTD의 "마지막 로그인" 시간을 약 6개월 전으로 표시.
- **이유**: §4.1 NEXUS 스토리 훅과 연계. 이전 주인이 사라진 시점을
  암시하는 첫 번째 단서로 기능. 구체적 시간은 기획 확정 후 조정 예정.

## 2026-02-26

### [04] 힌트 시스템 — 플레이어 능동 요청 기반
- **결정**: hint agent는 플레이어가 메일로 요청했을 때만 동작한다.
  게임이 먼저 힌트를 제시하지 않는다.
- **이유**: 퍼즐 주도권을 플레이어에게 유지하고, 막혔을 때만 도움을 받는
  구조로 난이도 체감을 조절하기 위함.

### [04] 힌트 라이브러리 — 온디맨드 첨부
- **결정**: 힌트는 import 가능한 stdlib 스크립트(`@name` 계약)로 답장에 첨부한다.
  게임 시작 시 기본 제공하지 않는다.
- **이유**: 초기 난이도 붕괴를 막고, "질문 -> 도구 획득 -> 적용" 학습 루프를
  플레이 흐름에 포함하기 위함.

### [13] DesktopOverlay — 모드 제한 및 전환 규칙
- **결정**: DesktopOverlay는 NATIVE_OS 모드에서만 활성화한다.
  VIRTUAL_DESKTOP 전환 시 즉시 비활성화하고, NATIVE_OS 복귀 시 저장된 상태를 복원한다.
- **이유**: 가상 데스크톱 배경과 역할이 중복되며, 모드 전환 시 Z-order/포커스
  충돌을 방지하기 위함.

### [13] DesktopOverlay — 포커스 비선점
- **결정**: DesktopOverlay는 `FLAG_NO_FOCUS`를 전제로 포커스를 획득하지 않으며,
  입력 포커스는 메인 터미널 창을 우선한다.
- **이유**: 배경창이 키보드 입력을 훔치면 핵심 플레이(터미널 조작)가 즉시 저해됨.

### [13] DesktopOverlay 저장 정책 — 임시 메모리 유지
- **결정**: 영속 저장 정책 확정 전까지 DesktopOverlay on/off 상태는 런타임 메모리에만 유지한다.
- **이유**: 저장 규격(See DOCS_INDEX.md -> 12)과의 경계가 확정되기 전, 구현 충돌을 피하기 위함.

### [15] 타겟 플레이어 범위 확정
- **결정**: 주 타겟은 코딩 경험자, 보조 타겟은 초보 코더로 둔다.
  코딩에 관심이 없는 플레이어는 타겟에서 제외한다.
- **이유**: 코딩 유도형 게임 정체성을 유지하고 온보딩/미션 설계 기준을 명확히 하기 위함.

### [03] import 사용자 문서 표기 예외
- **결정**: DocFX 사용자 문서에서 `import`는 모듈 형식(`Module ...`)으로 표기하지 않고,
  독립 intrinsic 이름인 `import`로 표기한다.
- **이유**: `import`는 `ssh/fs/net`처럼 모듈 map이 아니라 MiniScript 전역 intrinsic 함수이므로,
  모듈 표기를 쓰면 API 성격이 왜곡된다.

### [03] import 타입맵 동기화 정책
- **결정**: `import` 성공 실행 후 child VM의 `listType/mapType/stringType` 변경을 caller VM으로 동기화한다.
  충돌은 **나중 import 우선(덮어쓰기)** 으로 처리하고, 실패한 import 결과는 반영하지 않는다.
- **이유**: `listUtil/mapUtil/stringUtil`처럼 타입 메서드를 패치하는 라이브러리의 변경이
  호출자 스크립트에서 즉시 보이도록 보장하면서, 실패 경로의 부분 반영으로 인한 상태 오염을 방지하기 위함.

### [07] ping async 실행 정책
- **결정**: `ping`은 터미널 프로그램 async 실행 경로로 편입해 실시간 probe 출력을 스트리밍하고,
  실행 중에는 miniscript와 동일하게 입력 제출을 차단하며 `Ctrl+C`로 즉시 중단할 수 있게 한다.
  기존 동기 `ExecuteTerminalCommand("ping ...")` 경로는 호환성을 위해 유지한다.
- **이유**: 동기 `ping` 실행으로 인한 프리즈를 제거하고, 긴 실행 커맨드의 UX를 miniscript와 동일한
  단일 규칙으로 통일하기 위함이다.
